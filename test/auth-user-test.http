### Base URL and Variables
@baseUrl = http://localhost:8080/api/v1
@contentType = application/json

### Admin credentials (set these values according to your admin user)
### @adminEmail = admin@example.com
### @adminPassword = AdminPassword123!
### @adminUsername = admin

### [PUBLIC] Health Check
# @name healthCheck
GET {{baseUrl}}/health
Content-Type: {{contentType}}

> {%
    client.test("Health Check - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.message.includes("healthy"), "Message doesn't indicate health");
    });
%}

### [PUBLIC] Register New User
# @name register
POST {{baseUrl}}/auth/register
Content-Type: {{contentType}}

{
  "username": "testuser{{$timestamp}}",
  "password": "Password123!",
  "name": "Test User {{$timestamp}}",
  "email": "testuser{{$timestamp}}@example.com"
}

> {%
    client.test("Register User - Success", function() {
        client.assert(response.status === 201, "Response status is not 201");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.id, "User ID not found in response");
        client.assert(response.body.data.username, "Username not found in response");
        client.assert(response.body.data.email, "Email not found in response");

        // Simpan user ID untuk test selanjutnya
        client.global.set("userId", response.body.data.id);
        client.global.set("testUsername", response.body.data.username);
        client.global.set("testEmail", response.body.data.email);
        client.global.set("testPassword", "Password123!");
    });
%}

### [PUBLIC] Login User
# @name loginByEmail
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
  "login": "{{testEmail}}",
  "password": "{{testPassword}}"
}

> {%
    client.test("Login User - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.access_token, "Access token not found");
        client.assert(response.body.data.refresh_token, "Refresh token not found");
        client.assert(response.body.data.user.id === client.global.get("userId"), "User ID mismatch");

        // Set environment variables secara manual
        client.global.set("authToken", response.body.data.access_token);
        client.global.set("refreshToken", response.body.data.refresh_token);
    });
%}

### [PUBLIC] Login User by Username
# @name loginByUsername
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
  "login": "{{testUsername}}",
  "password": "{{testPassword}}"
}

> {%
    client.test("Login User - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.access_token, "Access token not found");
        client.assert(response.body.data.refresh_token, "Refresh token not found");
        client.assert(response.body.data.user.id === client.global.get("userId"), "User ID mismatch");

        // Set environment variables secara manual
        client.global.set("authToken", response.body.data.access_token);
        client.global.set("refreshToken", response.body.data.refresh_token);
    });
%}

### [PUBLIC] Login Admin
# @name loginAdminByEmail
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
  "login": "{{adminEmail}}",
  "password": "{{adminPassword}}"
}

> {%
    client.test("Login Admin - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.access_token, "Access token not found");
        client.assert(response.body.data.refresh_token, "Refresh token not found");

        // Set environment variables secara manual
        client.global.set("adminAuthToken", response.body.data.access_token);
        client.global.set("adminRefreshToken", response.body.data.refresh_token);
    });
%}

### [AUTH] Get Current User Profile (as regular user)
# @name getProfile
GET {{baseUrl}}/profile
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

> {%
    client.test("Get Profile - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.id === client.global.get("userId"), "User ID mismatch");
    });
%}

### [AUTH] Get Current Admin Profile
# @name getAdminProfile
GET {{baseUrl}}/profile
Authorization: Bearer {{adminAuthToken}}
Content-Type: {{contentType}}

> {%
    client.test("Get Admin Profile - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.roles && response.body.data.roles.length > 0, "User roles not found");

        // Check if user has admin role
        let isAdmin = false;
        for (let role of response.body.data.roles) {
            if (role.name === "admin") {
                isAdmin = true;
                break;
            }
        }
        client.assert(isAdmin, "User is not an admin");

        // Simpan role id pertama (opsional, bisa pilih yang name == admin)
        const adminRole = response.body.data.roles.find(role => role.name === "admin");
        if (adminRole) {
            client.global.set("adminRoleId", adminRole.id);
        }
    });
%}

### [ADMIN] Create User as Admin (with default role)
# @name postUserAsAdmin
POST {{baseUrl}}/users
Authorization: Bearer {{adminAuthToken}}
Content-Type: {{contentType}}

{
  "username": "admincreated{{$timestamp}}",
  "password": "Password123!",
  "name": "Admin Created User {{$timestamp}}",
  "email": "admincreated{{$timestamp}}@example.com"
}

> {%
    client.test("Create User as Admin - Success", function() {
        client.assert(response.status === 201, "Response status is not 201");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.id, "User ID not found in response");

        // Simpan user ID untuk test selanjutnya
        client.global.set("adminCreatedUserId", response.body.data.id);
        const userRole = response.body.data.roles.find(role => role.name === "user");
        if (userRole) {
            client.global.set("userRoleId", userRole.id);
        }
    });
%}

### [ADMIN] Create User as Admin (with specific role)
# @name postUserWithRoleAsAdmin
POST {{baseUrl}}/users
Authorization: Bearer {{adminAuthToken}}
Content-Type: {{contentType}}

{
  "username": "admincreatedwithrole{{$timestamp}}",
  "password": "Password123!",
  "name": "Admin Created User With Role {{$timestamp}}",
  "email": "admincreatedwithrole{{$timestamp}}@example.com",
  "role_ids": ["{{adminRoleId}}","{{userRoleId}}"]
}

> {%
    client.test("Create User with Role as Admin - Success", function() {
        client.assert(response.status === 201, "Response status is not 201");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.id, "User ID not found in response");

        // Simpan user ID untuk test selanjutnya
        client.global.set("adminCreatedUserWithRoleId", response.body.data.id);
    });
%}

### [USER] Try to Create User as Regular User (should fail)
# @name postUserAsUser
POST {{baseUrl}}/users
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "username": "usercreated{{$timestamp}}",
  "password": "Password123!",
  "name": "User Created User {{$timestamp}}",
  "email": "usercreated{{$timestamp}}@example.com"
}

> {%
    client.test("Create User as Regular User - Should Fail", function() {
        client.assert(response.status === 403, "Expected 403 Forbidden for regular user");
        client.assert(response.body.status === "error", "Expected error status");
    });
%}

### [ADMIN] Get All Users as Admin
# @name getAllUsersByAdmin
GET {{baseUrl}}/users?page=1&limit=10
Authorization: Bearer {{adminAuthToken}}
Content-Type: {{contentType}}

> {%
    client.test("Get All Users as Admin - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(Array.isArray(response.body.data), "Users array not found");

        // Simpan role ID admin untuk test selanjutnya
        if (response.body.data && response.body.data.length > 0) {
            for (let user of response.body.data) {
                if (user.roles && user.roles.length > 0) {
                    for (let role of user.roles) {
                        if (role.name === "admin") {
                            client.global.set("adminRoleId", role.id);
                            break;
                        }
                    }
                }
                if (client.global.get("adminRoleId")) break;
            }
        }
    });
%}

### [USER] Get All Users as Regular User (should fail)
# @name getAllUsersByUser
GET {{baseUrl}}/users?page=1&limit=10
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

> {%
    client.test("Get All Users as Regular User - Should Fail", function() {
        client.assert(response.status === 403, "Expected 403 Forbidden for regular user");
        client.assert(response.body.status === "error", "Expected error status");
    });
%}

### [ADMIN] Get User By ID as Admin
# @name getUserByIdAsAdmin
GET {{baseUrl}}/users/{{userId}}
Authorization: Bearer {{adminAuthToken}}
Content-Type: {{contentType}}

> {%
    client.test("Get User By ID as Admin - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.id === client.global.get("userId"), "User ID mismatch");
    });
%}

### [USER] Get User By ID as Regular User (own profile - should succeed)
# @name getUserByIdAsUser
GET {{baseUrl}}/users/{{userId}}
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

> {%
    client.test("Get Own User By ID as Regular User - Should Fail", function() {
        client.assert(response.status === 403, "Expected 403 Forbidden for accessing other user's data");
        client.assert(response.body.status === "error", "Expected error status");
    });
%}

### [USER] Get Other User By ID as Regular User (should fail)
# @name getOtherUserByIdAsUser
GET {{baseUrl}}/users/{{adminCreatedUserId}}
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

> {%
    client.test("Get Other User By ID as Regular User - Should Fail", function() {
        client.assert(response.status === 403, "Expected 403 Forbidden for accessing other user's data");
        client.assert(response.body.status === "error", "Expected error status");
    });
%}

### [ADMIN] Update User as Admin
# @name updateUserAsAdmin
PUT {{baseUrl}}/users/{{userId}}
Authorization: Bearer {{adminAuthToken}}
Content-Type: {{contentType}}

{
  "name": "Updated by Admin {{$timestamp}}",
  "email": "adminupdated{{$timestamp}}@example.com"
}

> {%
    client.test("Update User as Admin - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.name.includes("Updated by Admin"), "Name not updated by admin");
    });
%}

### [USER] Update Own User as Regular User
# @name updateOwnUserAsUser
PUT {{baseUrl}}/users/{{userId}}
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "name": "Updated by Self {{$timestamp}}",
  "email": "selfupdated{{$timestamp}}@example.com"
}

> {%
    client.test("Update Own User as Regular User - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.name.includes("Updated by Self"), "Name not updated by self");
    });
%}

### [USER] Update Other User as Regular User (should fail)
# @name updateOtherUserAsUser
PUT {{baseUrl}}/users/{{adminCreatedUserId}}
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "name": "Unauthorized Update {{$timestamp}}",
  "email": "unauthorized{{$timestamp}}@example.com"
}

> {%
    client.test("Update Other User as Regular User - Should Fail", function() {
        client.assert(response.status === 403, "Expected 403 Forbidden for updating other user");
        client.assert(response.body.status === "error", "Expected error status");
    });
%}

### [ADMIN] Change User Password as Admin
# @name changeUserPasswordAsAdmin
POST {{baseUrl}}/users/{{userId}}/change-password
Authorization: Bearer {{adminAuthToken}}
Content-Type: {{contentType}}

{
  "new_password": "AdminChangedPassword123!"
}

> {%
    client.test("Change User Password as Admin - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");

        // Update password untuk test selanjutnya
        client.global.set("testPassword", "AdminChangedPassword123!");
    });
%}

### [USER] Change Own Password as Regular User
# @name changeOwnPasswordAsUser
POST {{baseUrl}}/users/{{userId}}/change-password
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "current_password": "{{testPassword}}",
  "new_password": "UserChangedPassword123!"
}

> {%
    client.test("Change Own Password as Regular User - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");

        // Update password untuk test selanjutnya
        client.global.set("testPassword", "UserChangedPassword123!");
    });
%}

### [USER] Change Other User Password as Regular User (should fail)
# @name changeOtherUserPasswordAsUser
POST {{baseUrl}}/users/{{adminCreatedUserId}}/change-password
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "current_password": "wrongpassword",
  "new_password": "HackedPassword123!"
}

> {%
    client.test("Change Other User Password as Regular User - Should Fail", function() {
        client.assert(response.status === 403, "Expected 403 Forbidden for changing other user's password");
        client.assert(response.body.status === "error", "Expected error status");
    });
%}

### [ADMIN] Assign Role to User
# @name assignRoleToUser
POST {{baseUrl}}/users/{{userId}}/roles
Authorization: Bearer {{adminAuthToken}}
Content-Type: {{contentType}}

{
  "role_ids": ["{{adminRoleId}}"]
}

> {%
    client.test("Assign Role to User - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
    });
%}

### [ADMIN] Get User Roles
# @name getUserRoles
GET {{baseUrl}}/users/{{userId}}/roles
Authorization: Bearer {{adminAuthToken}}
Content-Type: {{contentType}}

> {%
    client.test("Get User Roles - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(Array.isArray(response.body.data), "Roles array not found");
    });
%}

### [ADMIN] Remove Role from User
# @name removeRoleFromUser
DELETE {{baseUrl}}/users/{{userId}}/roles/{{adminRoleId}}
Authorization: Bearer {{adminAuthToken}}
Content-Type: {{contentType}}

> {%
    client.test("Remove Role from User - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
    });
%}

### [ADMIN] Delete User as Admin
# @name deleteUserAsAdmin
DELETE {{baseUrl}}/users/{{adminCreatedUserId}}
Authorization: Bearer {{adminAuthToken}}
Content-Type: {{contentType}}

> {%
    client.test("Delete User as Admin - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
    });
%}

### [USER] Delete User as Regular User (should fail)
# @name deleteUserAsUser
DELETE {{baseUrl}}/users/{{userId}}
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

> {%
    client.test("Delete User as Regular User - Should Fail", function() {
        client.assert(response.status === 403, "Expected 403 Forbidden for regular user");
        client.assert(response.body.status === "error", "Expected error status");
    });
%}

### [AUTH] Refresh Access Token
# @name refreshToken
POST {{baseUrl}}/auth/refresh
Content-Type: {{contentType}}

{
  "refresh_token": "{{refreshToken}}"
}

> {%
    client.test("Refresh Token - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.access_token, "New access token not found");
        client.assert(response.body.data.refresh_token, "New refresh token not found");

        // Update token global untuk test selanjutnya
        client.global.set("authToken", response.body.data.access_token);
        client.global.set("refreshToken", response.body.data.refresh_token);
    });
%}

### [AUTH] Test with Invalid Token (should fail)
# @name invalidToken
GET {{baseUrl}}/users
Authorization: Bearer invalid_token_here
Content-Type: {{contentType}}

> {%
    client.test("Invalid Token - Should Fail", function() {
        client.assert(response.status === 401, "Expected 401 for invalid token");
        client.assert(response.body.status === "error", "Expected error status");
    });
%}

### [AUTH] Test Get Non-Existent User
# @name nonExistentUser
GET {{baseUrl}}/users/00000000-0000-0000-0000-000000000000
Authorization: Bearer {{adminAuthToken}}
Content-Type: {{contentType}}

> {%
    client.test("Non-Existent User - Should Fail", function() {
        client.assert(response.status === 404, "Expected 404 for non-existent user");
        client.assert(response.body.status === "error", "Expected error status");
    });
%}

### [AUTH] Logout User
# @name logout
POST {{baseUrl}}/auth/logout
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

> {%
    client.test("Logout - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
    });
%}

### [AUTH] Logout Admin
# @name logoutAdmin
POST {{baseUrl}}/auth/logout
Authorization: Bearer {{adminAuthToken}}
Content-Type: {{contentType}}

> {%
    client.test("Logout Admin - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
    });
%}

### [PUBLIC] Test Invalid Registration
# @name invalidRegister
POST {{baseUrl}}/auth/register
Content-Type: {{contentType}}

{
  "username": "test",
  "password": "short",
  "name": "Test",
  "email": "invalid-email"
}

> {%
    client.test("Invalid Registration - Should Fail", function() {
        client.assert(response.status === 400, "Expected 400 for invalid input");
        client.assert(response.body.status === "error", "Expected error status");
    });
%}

### [PUBLIC] Test Invalid Login
# @name invalidLogin
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
  "login": "nonexistentuser@invalid.com",
  "password": "wrongpassword"
}

> {%
    client.test("Invalid Login - Should Fail", function() {
        client.assert(response.status === 401, "Expected 401 for invalid credentials");
        client.assert(response.body.status === "error", "Expected error status");
    });
%}

### [PUBLIC] Test Without Token (should fail)
# @name noToken
GET {{baseUrl}}/users
Content-Type: {{contentType}}

> {%
    client.test("No Token - Should Fail", function() {
        client.assert(response.status === 401, "Expected 401 for missing token");
        client.assert(response.body.status === "error", "Expected error status");
    });
%}

### Test Sequence Completion Check
# @name completionCheck
GET {{baseUrl}}/health
Content-Type: {{contentType}}

> {%
    client.test("Test Sequence Completed", function() {
        client.assert(response.status === 200, "Final health check failed");
        client.log("âœ… All tests completed successfully!");
    });
%}