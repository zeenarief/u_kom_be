### Base URL and Variables
@baseUrl = http://localhost:8080/api/v1
@contentType = application/json

### [PUBLIC] Health Check
# @name healthCheck
GET {{baseUrl}}/health
Content-Type: {{contentType}}

> {%
    client.test("Health Check - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.message.includes("healthy"), "Message doesn't indicate health");
    });
%}

### [PUBLIC] Register New User
# @name register
POST {{baseUrl}}/auth/register
Content-Type: {{contentType}}

{
  "username": "testuser{{$timestamp}}",
  "password": "Password123!",
  "name": "Test User {{$timestamp}}",
  "email": "testuser{{$timestamp}}@example.com"
}

> {%
    client.test("Register User - Success", function() {
        client.assert(response.status === 201, "Response status is not 201");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.id, "User ID not found in response");
        client.assert(response.body.data.username, "Username not found in response");
        client.assert(response.body.data.email, "Email not found in response");

        // Simpan user ID untuk test selanjutnya
        client.global.set("userId", response.body.data.id);
        client.global.set("testUsername", response.body.data.username);
        client.global.set("testEmail", response.body.data.email);
        client.global.set("testPassword", "Password123!");
    });
%}

### [PUBLIC] Login User
# @name login
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
  "email": "{{testEmail}}",
  "password": "{{testPassword}}"
}

> {%
    client.test("Login User - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.access_token, "Access token not found");
        client.assert(response.body.data.refresh_token, "Refresh token not found");
        client.assert(response.body.data.user.id === client.global.get("userId"), "User ID mismatch");

        // Set environment variables secara manual
        client.global.set("authToken", response.body.data.access_token);
        client.global.set("refreshToken", response.body.data.refresh_token);
    });
%}

### [AUTH] Get Current User Profile
# @name getProfile
GET {{baseUrl}}/profile
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

> {%
    client.test("Get Profile - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.id === client.global.get("userId"), "User ID mismatch");
    });
%}

### [PUBLIC] Register New User
# @name postUser
POST {{baseUrl}}/users
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "username": "testuser{{$timestamp}}",
  "password": "Password123!",
  "name": "Test User from User {{$timestamp}}",
  "email": "testuser{{$timestamp}}@example.com"
}

> {%
    client.test("Register User - Success", function() {
        client.assert(response.status === 201, "Response status is not 201");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.id, "User ID not found in response");
        client.assert(response.body.data.username, "Username not found in response");
        client.assert(response.body.data.email, "Email not found in response");

        // Simpan user ID untuk test selanjutnya
        client.global.set("userId", response.body.data.id);
        client.global.set("testUsername", response.body.data.username);
        client.global.set("testEmail", response.body.data.email);
        client.global.set("testPassword", "Password123!");
    });
%}

### [AUTH] Get All Users
# @name getAllUsers
GET {{baseUrl}}/users?page=1&limit=10
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

> {%
    client.test("Get All Users - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(Array.isArray(response.body.data), "Users array not found");
    });
%}

### [AUTH] Get User By ID
# @name getUserById
GET {{baseUrl}}/users/{{userId}}
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

> {%
    client.test("Get User By ID - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.id === client.global.get("userId"), "User ID mismatch");
    });
%}

### [AUTH] Update User
# @name updateUser
PUT {{baseUrl}}/users/{{userId}}
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "name": "1Updated Test User {{$timestamp}}",
  "email": "updated{{$timestamp}}@example.com"
}

> {%
    client.test("Update User - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.name.includes("Updated"), "Name not updated");
    });
%}

### [AUTH] Change Password
# @name changePassword
POST {{baseUrl}}/users/{{userId}}/change-password
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "current_password": "{{testPassword}}",
  "new_password": "NewPassword123!"
}

> {%
    client.test("Change Password - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");

        // Update password untuk test selanjutnya
        client.global.set("testPassword", "NewPassword123!");
    });
%}

### [AUTH] Refresh Access Token
# @name refreshToken
POST {{baseUrl}}/auth/refresh
Content-Type: {{contentType}}

{
  "refresh_token": "{{refreshToken}}"
}

> {%
    client.test("Refresh Token - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.access_token, "New access token not found");
        client.assert(response.body.data.refresh_token, "New refresh token not found");

        // Update token global untuk test selanjutnya
        client.global.set("authToken", response.body.data.access_token);
        client.global.set("refreshToken", response.body.data.refresh_token);
    });
%}

### [AUTH] Logout User
# @name logout
POST {{baseUrl}}/auth/logout
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

> {%
    client.test("Logout - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
    });
%}

### [PUBLIC] Test Invalid Registration
# @name invalidRegister
POST {{baseUrl}}/auth/register
Content-Type: {{contentType}}

{
  "username": "test",
  "password": "short",
  "name": "Test",
  "email": "invalid-email"
}

> {%
    client.test("Invalid Registration - Should Fail", function() {
        client.assert(response.status === 400, "Expected 400 for invalid input");
        client.assert(response.body.status === "error", "Expected error status");
    });
%}

### [PUBLIC] Test Invalid Login
# @name invalidLogin
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
  "email": "nonexistentuser@invalid.com",
  "password": "wrongpassword"
}

> {%
    client.test("Invalid Login - Should Fail", function() {
        client.assert(response.status === 401, "Expected 401 for invalid credentials");
        client.assert(response.body.status === "error", "Expected error status");
    });
%}

### [PUBLIC] Test Without Token (should fail)
# @name noToken
GET {{baseUrl}}/users
Content-Type: {{contentType}}

> {%
    client.test("No Token - Should Fail", function() {
        client.assert(response.status === 401, "Expected 401 for missing token");
        client.assert(response.body.status === "error", "Expected error status");
    });
%}

### [AUTH] Test with Invalid Token (should fail)
# @name invalidToken
GET {{baseUrl}}/users
Authorization: Bearer invalid_token_here
Content-Type: {{contentType}}

> {%
    client.test("Invalid Token - Should Fail", function() {
        client.assert(response.status === 401, "Expected 401 for invalid token");
        client.assert(response.body.status === "error", "Expected error status");
    });
%}

### [AUTH] Test Get Non-Existent User
# @name nonExistentUser
GET {{baseUrl}}/users/00000000-0000-0000-0000-000000000000
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

> {%
    client.test("Non-Existent User - Should Fail", function() {
        client.assert(response.status === 404, "Expected 404 for non-existent user");
        client.assert(response.body.status === "error", "Expected error status");
    });
%}

### [AUTH] Test Update Other User (should fail if not admin)
# @name updateOtherUser
PUT {{baseUrl}}/users/00000000-0000-0000-0000-000000000000
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "name": "Other User",
  "email": "other@example.com"
}

> {%
    client.test("Update Other User - Should Fail", function() {
        client.assert(response.status === 403 || response.status === 404, "Expected 403/404 for other user update");
        client.assert(response.body.status === "error", "Expected error status");
    });
%}

### Test Sequence Completion Check
# @name completionCheck
GET {{baseUrl}}/health
Content-Type: {{contentType}}

> {%
    client.test("Test Sequence Completed", function() {
        client.assert(response.status === 200, "Final health check failed");
        client.log("âœ… All tests completed successfully!");
    });
%}