### Base URL and Variables
@baseUrl = http://localhost:8080/api/v1
@contentType = application/json

# Global variables untuk menyimpan state
@authToken =
@refreshToken =
@userId =

### [PUBLIC] Health Check
# @name healthCheck
GET {{baseUrl}}/health
Content-Type: {{contentType}}

> {%
    client.test("Health Check - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.message.includes("healthy"), "Message doesn't indicate health");
    });
%}

### [PUBLIC] Register New User
# @name register
POST {{baseUrl}}/auth/register
Content-Type: {{contentType}}

{
  "username": "testuser{{$timestamp}}",
  "password": "Password123!",
  "name": "Test User {{$timestamp}}",
  "email": "testuser{{$timestamp}}@example.com"
}

> {%
    client.test("Register User - Success", function() {
        client.assert(response.status === 201, "Response status is not 201");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.id, "User ID not found in response");
        client.assert(response.body.data.username, "Username not found in response");
        client.assert(response.body.data.email, "Email not found in response");

        // Simpan user ID untuk test selanjutnya
        client.global.set("userId", response.body.data.id);
    });
%}

### [PUBLIC] Login User
# @name login
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
  "username": "{{register.response.body.data.username}}",
  "password": "Password123!"
}

> {%
    client.test("Login User - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.access_token, "Access token not found");
        client.assert(response.body.data.refresh_token, "Refresh token not found");
        client.assert(response.body.data.user.id === client.global.get("userId"), "User ID mismatch");

        // Set environment variables secara manual
        client.global.set("authToken", response.body.data.access_token);
        client.global.set("refreshToken", response.body.data.refresh_token);
    });
%}

### [AUTH] Get Current User Profile
GET {{baseUrl}}/users/me
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

> {%
    client.test("Get Profile - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.id === client.global.get("userId"), "User ID mismatch");
    });
%}

### [AUTH] Refresh Access Token
# @name refresh
POST {{baseUrl}}/auth/refresh
Content-Type: {{contentType}}

{
  "refresh_token": "{{refreshToken}}"
}

> {%
    client.test("Refresh Token - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.access_token, "New access token not found");
        client.assert(response.body.data.refresh_token, "New refresh token not found");

        // Update token global untuk test selanjutnya
        client.global.set("authToken", response.body.data.access_token);
        client.global.set("refreshToken", response.body.data.refresh_token);
    });
%}

### [AUTH] Get All Users
GET {{baseUrl}}/users?page=1&limit=10
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

> {%
    client.test("Get All Users - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(Array.isArray(response.body.data.users), "Users array not found");
        client.assert(response.body.data.pagination, "Pagination data not found");
    });
%}

### [AUTH] Get User By ID
GET {{baseUrl}}/users/{{userId}}
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

> {%
    client.test("Get User By ID - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.id === client.global.get("userId"), "User ID mismatch");
    });
%}

### [AUTH] Update User
PUT {{baseUrl}}/users/{{userId}}
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "name": "Updated Test User {{$timestamp}}",
  "email": "updated{{$timestamp}}@example.com"
}

> {%
    client.test("Update User - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
        client.assert(response.body.data.name.includes("Updated"), "Name not updated");
    });
%}

### [AUTH] Change Password
POST {{baseUrl}}/users/{{userId}}/change-password
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

{
  "current_password": "Password123!",
  "new_password": "NewPassword123!"
}

> {%
    client.test("Change Password - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
    });
%}

### [AUTH] Logout User
POST {{baseUrl}}/auth/logout
Authorization: Bearer {{authToken}}
Content-Type: {{contentType}}

> {%
    client.test("Logout - Success", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.status === "success", "Status is not success");
    });
%}